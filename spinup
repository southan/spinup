#!/usr/bin/env bash
# This script was generated by bashly 1.3.4 (https://bashly.dev)
# Modifying it manually is not recommended

if ((BASH_VERSINFO[0] < 4 || (BASH_VERSINFO[0] == 4 && BASH_VERSINFO[1] < 2))); then
	printf "bash version 4.2 or higher is required\n" >&2
	exit 1
fi

version_command() {
	echo "$version"
}

spinup_usage() {
	printf "spinup - Server management tools.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup COMMAND\n"
	printf "  spinup [COMMAND] --help | -h\n"
	printf "  spinup --version | -v\n"
	echo

	printf "%s\n" "$(bold "Commands:")"
	printf "  %s   Check sites.\n" "$(green "status") "
	printf "  %s   List sites.\n" "$(green "sites")  "
	printf "  %s   List site users.\n" "$(green "users")  "
	printf "  %s   Park a domain onto an existing site.\n" "$(green "park")   "
	printf "  %s   List parked domains.\n" "$(green "parked") "
	printf "  %s   Remove parked domain.\n" "$(green "unpark") "
	printf "  %s   Run WP-CLI command for all WordPress sites.\n" "$(green "wp")     "
	printf "  %s   Realtime traffic monitor.\n" "$(green "traffic")"
	printf "  %s   Manage server jail.\n" "$(green "jail")   "
	printf "  %s   Manage Redis servers.\n" "$(green "redis")  "
	printf "  %s   Configure server.\n" "$(green "setup")  "
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo
		printf "  %s\n" "$(magenta "--version, -v")"
		printf "    Show version number\n"
		echo

	fi
}

spinup_status_usage() {
	printf "spinup status - Check sites.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup status [SITE...]\n"
	printf "  spinup status --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "SITE...")"
		printf "    Username, domain, or glob pattern.\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  List status for all sites\n  $ spinup status\n  \n  List status for specific sites\n  $ spinup status one.example.com two.example.com three.example.com\n  \n  List status for all staging sites\n  $ spinup status 'staging.*'\n  \n  List status for all non staging sites\n  $ spinup status '!staging.*'\n  \n  List status for all .com sites except staging\n  $ spinup status '*.com' '!staging.*'\n"
		echo

	fi
}

spinup_sites_usage() {
	printf "spinup sites - List sites.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup sites\n"
	printf "  spinup sites --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

spinup_users_usage() {
	printf "spinup users - List site users.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup users\n"
	printf "  spinup users --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

spinup_park_usage() {
	printf "spinup park - Park a domain onto an existing site.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup park DOMAIN [SITE] [OPTIONS]\n"
	printf "  spinup park --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--use-dns")"
		printf "    Validate SSL via DNS TXT records (interactive).\n"
		echo

		printf "  %s\n" "$(magenta "--exact")"
		printf "    Disable handling www alias.\n"
		echo

		printf "  %s\n" "$(magenta "--force")"
		printf "    Override if already exists.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "DOMAIN")"
		printf "    Domain to be parked.\n"
		echo

		printf "  %s\n" "$(blue "SITE")"
		printf "    Site to park onto.\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Park domain ahead of pointing DNS (interactive TXT record changes required)\n  $ spinup park example.com --use-dns\n  \n  Park example.com WITHOUT www\n  $ spinup park example.com --exact\n  \n  Park ONLY www.example.com\n  $ spinup park www.example.com --exact\n"
		echo

	fi
}

spinup_parked_usage() {
	printf "spinup parked - List parked domains.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup parked\n"
	printf "  spinup parked --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

spinup_unpark_usage() {
	printf "spinup unpark - Remove parked domain.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup unpark DOMAIN [SITE] [OPTIONS]\n"
	printf "  spinup unpark --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--exact")"
		printf "    Disable handling www alias.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "DOMAIN")"
		printf "    Domain to be unparked.\n"
		echo

		printf "  %s\n" "$(blue "SITE")"
		printf "    Site to unpark from.\n"
		echo

	fi
}

spinup_wp_usage() {
	if [[ -n $long_usage ]]; then
		printf "spinup wp\n\n"
		printf "  Run WP-CLI command for all WordPress sites.\n  \n  Use '--' to separate sites to run for and the WP-CLI command to run.\n\n"
	else
		printf "spinup wp - Run WP-CLI command for all WordPress sites.\n\n"
	fi

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup wp [--] [...]\n"
	printf "  spinup wp --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Get option 'home' for all WordPress sites\n  $ spinup wp option get home\n  \n  Get option 'home' for all .dev sites\n  $ spinup wp *.dev -- option get home\n  \n  Prompt to select sites\n  $ spinup wp -- option get home\n"
		echo

	fi
}

spinup_traffic_usage() {
	printf "spinup traffic - Realtime traffic monitor.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup traffic\n"
	printf "  spinup traffic --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

spinup_jail_usage() {
	printf "spinup jail - Manage server jail.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup jail COMMAND\n"
	printf "  spinup jail [COMMAND] --help | -h\n"
	echo

	printf "%s\n" "$(bold "Commands:")"
	printf "  %s   Display jail status.\n" "$(green "status")"
	printf "  %s   Remove IPs from all jails.\n" "$(green "remove")"
	printf "  %s   List or add IPs to the jail ignore list.\n" "$(green "ignore")"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Check jail status\n  $ spinup jail status\n  \n  Check specific jail status with additional info\n  $ spinup jail status wp-login\n  \n  Remove an IP from jail\n  $ spinup jail remove 1.2.3.4\n  \n  Display ignored IPs\n  $ spinup ignore\n  \n  Ignore IP\n  $ spinup ignore 1.2.3.4\n  \n  Clear all ignored IPs\n  $spinup ignore --clear\n  \n  Unignore IP\n  $spinup ignore --clear 1.2.3.4\n"
		echo

	fi
}

spinup_jail_status_usage() {
	printf "spinup jail status - Display jail status.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup jail status [JAIL]\n"
	printf "  spinup jail status --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "JAIL")"
		printf "    Additional info for specific jail.\n"
		echo

	fi
}

spinup_jail_remove_usage() {
	printf "spinup jail remove - Remove IPs from all jails.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup jail remove IP...\n"
	printf "  spinup jail remove --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "IP...")"
		printf "\n"
		echo

	fi
}

spinup_jail_ignore_usage() {
	printf "spinup jail ignore - List or add IPs to the jail ignore list.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup jail ignore [IP...] [OPTIONS]\n"
	printf "  spinup jail ignore --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--clear")"
		printf "    Remove IP from ignore list.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "IP...")"
		printf "\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Display ignored IPs\n  $ spinup ignore\n  \n  Ignore IP\n  $ spinup ignore 1.2.3.4\n  \n  Clear all ignored IPs\n  $spinup ignore --clear\n  \n  Unignore IP\n  $spinup ignore --clear 1.2.3.4\n"
		echo

	fi
}

spinup_redis_usage() {
	printf "spinup redis - Manage Redis servers.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup redis COMMAND\n"
	printf "  spinup redis [COMMAND] --help | -h\n"
	echo

	printf "%s\n" "$(bold "Commands:")"
	printf "  %s   List Redis servers and their state.\n" "$(green "list")"
	printf "  %s   Enable Redis server(s).\n" "$(green "on")  "
	printf "  %s   Disable Redis servers.\n" "$(green "off") "
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  List Redis servers\n  $ spinup redis list\n  \n  Enable Redis servers\n  $ spinup redis on\n  \n  Disable Redis servers\n  $ spinup redis off\n"
		echo

	fi
}

spinup_redis_list_usage() {
	printf "spinup redis list - List Redis servers and their state.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup redis list [OPTIONS]\n"
	printf "  spinup redis list --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--ping")"
		printf "    Additional check to ensure Redis is OK.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

spinup_redis_on_usage() {
	printf "spinup redis on - Enable Redis server(s).\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup redis on [SITE...] [OPTIONS]\n"
	printf "  spinup redis on --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--memory MEMORY_LIMIT")"
		printf "    Set Redis memory limit.\n"
		printf "    %s\n" "Default: 256MB"
		echo

		printf "  %s\n" "$(magenta "--all")"
		printf "    Enable Redis servers for all sites.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "SITE...")"
		printf "    Username, domain, or glob e.g. *.dev or !*.dev\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Enable Redis for all .dev sites\n  $ spinup redis on '*.dev'\n  \n  Enable Redis for all sites OTHER than .dev\n  $ spinup redis on '!*.dev'\n"
		echo

	fi
}

spinup_redis_off_usage() {
	printf "spinup redis off - Disable Redis servers.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup redis off [SITE...] [OPTIONS]\n"
	printf "  spinup redis off --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--all")"
		printf "    Disable all Redis servers.\n"
		echo

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

		printf "%s\n" "$(bold "Arguments:")"

		printf "  %s\n" "$(blue "SITE...")"
		printf "    Username, domain, glob e.g. *.dev or negated glob e.g. !*.dev\n"
		echo

		printf "%s\n" "$(bold "Examples:")"
		printf "  Disable Redis for all .dev sites\n  $ spinup redis off '*.dev'\n  \n  Disable Redis for all sites OTHER than .dev\n  $ spinup redis off '!*.dev'\n"
		echo

	fi
}

spinup_setup_usage() {
	printf "spinup setup - Configure server.\n\n"

	printf "%s\n" "$(bold "Usage:")"
	printf "  spinup setup\n"
	printf "  spinup setup --help | -h\n"
	echo

	if [[ -n "$long_usage" ]]; then

		printf "%s\n" "$(bold "Options:")"

		printf "  %s\n" "$(magenta "--help, -h")"
		printf "    Show this help\n"
		echo

	fi
}

normalize_input() {
	local arg passthru flags
	passthru=false

	while [[ $# -gt 0 ]]; do
		arg="$1"
		if [[ $passthru == true ]]; then
			input+=("$arg")
		elif [[ $arg =~ ^(--[a-zA-Z0-9_\-]+)=(.+)$ ]]; then
			input+=("${BASH_REMATCH[1]}")
			input+=("${BASH_REMATCH[2]}")
		elif [[ $arg =~ ^(-[a-zA-Z0-9])=(.+)$ ]]; then
			input+=("${BASH_REMATCH[1]}")
			input+=("${BASH_REMATCH[2]}")
		elif [[ $arg =~ ^-([a-zA-Z0-9][a-zA-Z0-9]+)$ ]]; then
			flags="${BASH_REMATCH[1]}"
			for ((i = 0; i < ${#flags}; i++)); do
				input+=("-${flags:i:1}")
			done
		elif [[ "$arg" == "--" ]]; then
			passthru=true
			input+=("$arg")
		else
			input+=("$arg")
		fi

		shift
	done
}

enable_auto_colors() {
	if [[ -z ${NO_COLOR+x} && ! -t 1 ]]; then
		NO_COLOR=1
	fi
}

print_in_color() {
	local color="$1"
	shift
	if [[ "${NO_COLOR:-}" == "" ]]; then
		printf "$color%b\e[0m\n" "$*"
	else
		printf "%b\n" "$*"
	fi
}

red() { print_in_color "\e[31m" "$*"; }
green() { print_in_color "\e[32m" "$*"; }
yellow() { print_in_color "\e[33m" "$*"; }
blue() { print_in_color "\e[34m" "$*"; }
magenta() { print_in_color "\e[35m" "$*"; }
cyan() { print_in_color "\e[36m" "$*"; }
black() { print_in_color "\e[30m" "$*"; }
white() { print_in_color "\e[37m" "$*"; }

bold() { print_in_color "\e[1m" "$*"; }
underlined() { print_in_color "\e[4m" "$*"; }

red_bold() { print_in_color "\e[1;31m" "$*"; }
green_bold() { print_in_color "\e[1;32m" "$*"; }
yellow_bold() { print_in_color "\e[1;33m" "$*"; }
blue_bold() { print_in_color "\e[1;34m" "$*"; }
magenta_bold() { print_in_color "\e[1;35m" "$*"; }
cyan_bold() { print_in_color "\e[1;36m" "$*"; }
black_bold() { print_in_color "\e[1;30m" "$*"; }
white_bold() { print_in_color "\e[1;37m" "$*"; }

red_underlined() { print_in_color "\e[4;31m" "$*"; }
green_underlined() { print_in_color "\e[4;32m" "$*"; }
yellow_underlined() { print_in_color "\e[4;33m" "$*"; }
blue_underlined() { print_in_color "\e[4;34m" "$*"; }
magenta_underlined() { print_in_color "\e[4;35m" "$*"; }
cyan_underlined() { print_in_color "\e[4;36m" "$*"; }
black_underlined() { print_in_color "\e[4;30m" "$*"; }
white_underlined() { print_in_color "\e[4;37m" "$*"; }

#!/usr/bin/env bash

success() {
	echo "$(green ✓) $1"
}

error() {
	echo "$(red ✗) $1" >&2
}

warning() {
	echo "$(yellow ⚠) $1" >&2
}

notice() {
	echo "$(cyan ⓘ) $1" >&2
}

status_marker() {
	case $1 in
		0) green ●;;
		1) red ●;;
		2) yellow ●;;
		3) cyan ●;;
		*) echo ○;;
	esac
}

SPINUP_ERRORS=()
SPINUP_WARNINGS=()
SPINUP_NOTICES=()

add_error() {
	SPINUP_ERRORS+=("$1")
}

add_warning() {
	SPINUP_WARNINGS+=("$1")
}

add_notice() {
	SPINUP_NOTICES+=("$1")
}

print_tree_list() {
	local count=$#
	local prefix

	for (( i=1; i<=count; i++ )); do
		(( i == count )) && prefix='└' || prefix='├'
		echo "$prefix ${!i}"
	done
}

print_numbered_list() {
	printf '%s\n' "$@" | nl -w$# -s ') ' | column
}

print_messages() {
	local label=$1

	if [[ -n $label ]]; then
		local status=0

		if (( ${#SPINUP_ERRORS[@]} )); then
			status=1
		elif (( ${#SPINUP_WARNINGS[@]} )); then
			status=2
		elif (( ${#SPINUP_NOTICES[@]} )); then
			status=3
		fi

		echo "$(status_marker $status) $label"
	fi

	local messages
	messages=(
		"${SPINUP_ERRORS[@]/#/"$(red ✗) "}"
		"${SPINUP_WARNINGS[@]/#/"$(yellow ⚠) "}"
		"${SPINUP_NOTICES[@]/#/"$(cyan ⓘ) "}"
	)

	SPINUP_ERRORS=()
	SPINUP_WARNINGS=()
	SPINUP_NOTICES=()

	if (( ${#messages[@]} == 0 )); then
		return 0
	fi

	if [[ -z $label ]]; then
		printf '%s\n' "${messages[@]}"
	else
		print_tree_list "${messages[@]}"
	fi
}

ini_load() {
	unset ini
	declare -gA ini

	local ini_file="$1"

	local section=""
	local key=""
	local value=""
	local section_regex="^\[(.+)\]"
	local key_regex="^([^ =]+) *= *(.*) *$"
	local comment_regex="^;"

	while IFS= read -r line; do
		if [[ $line =~ $comment_regex ]]; then
			continue
		elif [[ $line =~ $section_regex ]]; then
			section="${BASH_REMATCH[1]}."
		elif [[ $line =~ $key_regex ]]; then
			key="${BASH_REMATCH[1]}"
			value="${BASH_REMATCH[2]}"
			[[ $value == *\$* ]] && eval "value=\"$value\""
			ini["${section}${key}"]="$value"
		fi
	done <"$ini_file"
}

ini_save() {
	declare -gA ini

	local ini_file="$1"

	local current_section=""
	local has_free_keys=false

	rm -f "$ini_file"

	for key in $(ini_keys); do
		[[ $key == *.* ]] && continue
		has_free_keys=true
		value="${ini[$key]}"
		echo "$key = $value" >>"$ini_file"
	done

	[[ "${has_free_keys}" == "true" ]] && echo >>"$ini_file"

	for key in $(ini_keys); do
		[[ $key == *.* ]] || continue
		value="${ini[$key]}"
		IFS="." read -r section_name key_name <<<"$key"

		if [[ "$current_section" != "$section_name" ]]; then
			[[ $current_section ]] && echo >>"$ini_file"
			echo "[$section_name]" >>"$ini_file"
			current_section="$section_name"
		fi

		echo "$key_name = $value" >>"$ini_file"
	done
}

ini_show() {
	declare -gA ini

	for key in $(ini_keys); do
		echo "$key = ${ini[$key]}"
	done
}

ini_keys() {
	declare -gA ini

	local keys=("${!ini[@]}")
	for a in "${keys[@]}"; do echo "$a"; done | sort
}

#!/usr/bin/env bash

set_site() {
	SITE=$1
	SITE_HOME="/sites/$SITE"
	set_user "${2:-${SPINUP_USERS[$SITE]}}"
}

set_user() {
	SITE_USER=$1
	REDIS_SOCKET="/run/redis-$SITE_USER/redis-$SITE_USER.sock"
	REDIS_CONFIG_FILE="/etc/redis.d/redis-$SITE_USER.conf"
	REDIS_SERVICE_FILE="/etc/systemd/system/redis-$SITE_USER.service"
}

list_sites() {
	find /sites/ -mindepth 1 -maxdepth 1 -type d -not -name '.*' -printf '%f\t%u\n' |
	while read -r site user; do
		printf '%s\t%s\t%s\n' "${site#www.}" "$site" "$user"
	done |
	sort |
	cut -f2-
}

init_sites() {
	SPINUP_SITES=()
	declare -gA SPINUP_USERS=()
	declare -gA SPINUP_SITES_BY_USER=()

	declare -F SPINUP_SITES_FILTER > /dev/null
	local skip_filter=$?

	local site user
	while read -r site user; do
		SPINUP_USERS[$site]=$user
		SPINUP_SITES_BY_USER[$user]=$site
		if (( skip_filter )) || SPINUP_SITES_FILTER "$site"; then
			SPINUP_SITES+=("$site")
		fi
	done < <(list_sites)
}

match_sites() {
	local matched_sites=()

	local has_accept
	declare -F SPINUP_ACCEPT_SITE > /dev/null && has_accept=1 || has_accept=0

	local arg
	local site
	local site_index
	for arg in "$@"; do
		if [[ $arg == '!'* ]]; then
			arg=${arg#!}
			(( ${#matched_sites[@]} )) || matched_sites=("${SPINUP_SITES[@]}")
			for site_index in "${!matched_sites[@]}"; do
				site=${matched_sites[$site_index]}
				# shellcheck disable=SC2053
				if [[ $site == $arg || ${SPINUP_USERS[$site]} == $arg ]]; then
					unset "matched_sites[$site_index]"
				fi
			done
		elif [[ $arg == *'*'* ]]; then
			for site in "${SPINUP_SITES[@]}"; do
				# shellcheck disable=SC2053
				if [[ $site == $arg || ${SPINUP_USERS[$site]} == $arg ]]; then
					matched_sites+=("$site")
				fi
			done
		elif [[ -n ${SPINUP_USERS[$arg]} ]]; then
			matched_sites+=("$arg")
		elif [[ -n ${SPINUP_SITES_BY_USER[$arg]} ]]; then
			matched_sites+=("${SPINUP_SITES_BY_USER[$arg]}")
		elif (( has_accept )) && SPINUP_ACCEPT_SITE "$arg"; then
			matched_sites+=("$arg")
		elif (( has_accept )); then
			abort "Site '$arg' is not available"
		else
			abort "Site '$arg' not found"
		fi
	done

	readarray -t SPINUP_SITES < <(printf '%s\n' "${matched_sites[@]}" | uniq)
}

select_sites() {
	local limit=$1
	local count=${#SPINUP_SITES[@]}

	printf '%s\n' "${SPINUP_SITES[@]}" | nl -w${#count} -s ') ' | column

	local choice
	local choices=()

	if [[ $limit == 1 ]]; then
		read -r -p 'Choose site: ' choice

		if [[ -z $choice ]]; then
			abort
		fi

		choices=("$choice")
	else
		read -r -p 'Choose site(s) (or continue): ' -a choices

		if (( ${#choices} == 0 )); then
			return 0
		fi
	fi

	local selected_sites=()

	local index
	for choice in "${choices[@]}"; do
		if [[ $choice =~ ^[0-9]+$ ]]; then
			index=$((choice - 1))

			if [[ -n ${SPINUP_SITES[$index]} ]]; then
				selected_sites+=("${SPINUP_SITES[$index]}")
			else
				abort "Invalid option #$choice"
			fi
		elif [[ " ${SPINUP_SITES[*]} " == *" $choice "* ]]; then
			selected_sites+=("$choice")
		else
			abort "Invalid choice '$choice'"
		fi
	done

	readarray -t SPINUP_SITES < <(printf '%s\n' "${selected_sites[@]}" | uniq)
}

require_sites() {
	init_sites

	local sites=("$@")
	if (( ${#sites[@]} == 0 )) && [[ -n ${args[site]} ]]; then
		eval "sites=(${args[site]})"
	fi

	if (( ${#sites[@]} )); then
		match_sites "${sites[@]}"
	elif [[ -z ${args[--all]} ]]; then
		select_sites
	fi

	if (( ${#SPINUP_SITES[@]} == 0 )); then
		abort 'No sites found.'
	fi
}

require_site() {
	init_sites

	local site="${1:-${args[site]}}"

	if [[ -n $site ]]; then
		match_sites "$site"
	else
		select_sites 1
	fi

	case ${#SPINUP_SITES[@]} in
		1) ;;
		0) abort 'No site found.' ;;
		*) abort "More than one site found: ${SPINUP_SITES[*]}" ;;
	esac

	set_site "${SPINUP_SITES[0]}"
}

confirm_sites() {
	if (( ${#SPINUP_SITES[@]} == 1 )); then
		if ! confirm "Continue for ${SPINUP_SITES[*]}?"; then
			abort
		fi
	else
		printf '● %s\n' "${SPINUP_SITES[@]}" | column
		if ! confirm 'Continue?'; then
			abort
		fi
	fi
}

confirm_site() {
	if ! confirm "Continue for $SITE?"; then
		abort
	fi
}

find_site_wp() {
	[[ -v SPINUP_SITES_WP ]] || declare -gA SPINUP_SITES_WP

	if [[ -v "SPINUP_SITES_WP[$SITE]" ]]; then
		SITE_WP=${SPINUP_SITES_WP[$SITE]}
	else
		SITE_WP="$SITE_HOME/files"

		if [[ ! -f "$SITE_WP/wp-load.php" ]]; then
			local wp_load_file
			wp_load_file=$(find "$SITE_WP" -maxdepth 3 -type f -name wp-load.php -print -quit 2>/dev/null)

			if [[ -n $wp_load_file ]]; then
				SITE_WP="${wp_load_file%/*}"
			else
				SITE_WP=''
			fi
		fi

		SPINUP_SITES_WP[$SITE]=$SITE_WP
	fi

	[[ -n $SITE_WP ]]
}

run_site_wp() {
	if [[ -z $SITE_WP ]]; then
		return 1
	fi

	sudo -u "$SITE_USER" wp --path="$SITE_WP" "$@"
}

user_has_redis() {
	if [[ ! -v REDIS_SERVICES ]]; then
		readarray -t REDIS_SERVICES < <(systemctl list-units 'redis-*.service' --all --plain --no-legend --no-pager | cut -f1 -d' ')
	fi

	[[ " ${REDIS_SERVICES[*]} " == *" redis-$1.service "* ]]
}

#!/usr/bin/env bash

abort() {
	[[ -n $1 ]] && echo "$(red ✗) $1" >&2
	exit 1
}

confirm() {
	local answer
	read -r -n 1 -p "$1 [y/N] " answer
	echo ""
	case "$answer" in
		[yY]) return 0 ;;
		*) return 1 ;;
	esac
}

read_ini() {
 	declare -g SPINUP_INI_FILE
 	SPINUP_INI_FILE=$1
	ini_load "$SPINUP_INI_FILE"
}

save_ini() {
 	declare -g SPINUP_INI_FILE
 	[[ -z $SPINUP_INI_FILE ]] && abort 'No INI file loaded.'
	local name
	name="$(basename "$SPINUP_INI_FILE" '.ini')-$RANDOM.ini"
	ini_save "$HOME/$name"
	sudo mv "$HOME/$name" "$SPINUP_INI_FILE"
	sudo chown root:root "$SPINUP_INI_FILE"
}

root_write() {
	if ! sudo tee "$1" >/dev/null; then
		abort "Failed to write to $1"
	fi
}

test_nginx() {
	if ! sudo nginx -t -q; then
		abort
	fi
}

reload_nginx() {
	test_nginx
	local output
	if ! output=$(sudo nginx -s reload 2>&1); then
		abort "$output"
	fi
}

spinup_status_command() {

	#!/usr/bin/env bash

	if [[ -n ${args[site]} ]]; then
		require_sites
	else
		init_sites
	fi

	for site in "${SPINUP_SITES[@]}"; do
		set_site "$site"

		wp_redis_status=''
		wp_redis_path=''
		wp_redis_scheme=''

		if find_site_wp; then
			if wp_dump=$(
				run_site_wp eval-file - 2>&1 <<-'PHP'
			<?php

			global $wp_object_cache;

			if ( defined( 'WP_REDIS_DISABLED' ) && WP_REDIS_DISABLED ) {
				$redis_status = 'disabled';
			} elseif ( ! method_exists( $wp_object_cache, 'redis_status' ) ) {
				$redis_status = 'missing';
			} elseif ( ! $wp_object_cache->redis_status() ) {
				$redis_status = 'error';
			} else {
				$redis_status = 'connected';
			}

			echo implode( "\n", [
				$redis_status,
				defined( 'WP_REDIS_SCHEME' ) ? WP_REDIS_SCHEME : '',
				defined( 'WP_REDIS_PATH' ) ? WP_REDIS_PATH : '',
				'--END--',
			]);
			PHP
		); then
			readarray -t wp_info < <(echo "$wp_dump" | tail -n 4)
			wp_redis_status=${wp_info[0]}
			wp_redis_scheme=${wp_info[1]}
			wp_redis_path=${wp_info[2]}
		else
			add_error "$wp_dump"
		fi
	fi

	if [[ -n $wp_redis_path || -f $REDIS_CONFIG_FILE || -f $REDIS_SERVICE_FILE || -S $REDIS_SOCKET ]]; then
		defined_redis_socket=${wp_redis_path:-$REDIS_SOCKET}
		if [[ -S $defined_redis_socket ]]; then
			redis_ping=$(sudo -u "$SITE_USER" redis-cli -s "$defined_redis_socket" PING 2>&1)

			if [[ $redis_ping != PONG ]]; then
				add_error "$redis_ping"
			fi
		elif [[ $wp_redis_status != disabled ]]; then
			add_error "Redis socket missing ($defined_redis_socket)"
		fi
	fi

	if [[ $wp_redis_status == disabled ]]; then
		add_warning 'Redis is disabled with WP_REDIS_DISABLED'
	elif [[ $wp_redis_status == missing ]]; then
		add_warning 'WordPress is missing Redis object cache dropin'
	elif [[ $wp_redis_status == error ]]; then
		add_error 'WordPress failed to connect to Redis'
	elif [[ $wp_redis_status == connected ]] && [[ -z $wp_redis_path || $wp_redis_scheme != 'unix' ]]; then
		add_notice 'Using shared Redis.'
	fi

	if [[ -n $wp_redis_path && $wp_redis_scheme != unix ]]; then
		add_warning "WP_REDIS_SCHEME is ${wp_redis_scheme:-not set} (should be 'unix')"
	elif [[ $wp_redis_scheme == unix && -z $wp_redis_path ]]; then
		add_error "WP_REDIS_SCHEME is 'unix' but WP_REDIS_PATH is not set"
	elif [[ -n $wp_redis_path && $wp_redis_path != "$REDIS_SOCKET" ]]; then
		add_warning "WP_REDIS_PATH is '$wp_redis_path' (expected '$REDIS_SOCKET')"
	fi

	print_messages "$site"
done

}

spinup_sites_command() {

	#!/usr/bin/env bash

	list_sites | while read -r site _; do
		echo "$site"
	done

}

spinup_users_command() {

	#!/usr/bin/env bash

	list_sites | while read -r _ user; do
		echo "$user"
	done

}

spinup_park_command() {

	#!/usr/bin/env bash

	require_site
	confirm_site

	domain=${args[domain]}
	use_dns=${args[--use-dns]}

	if [[ -n ${args[--exact]} ]]; then
		domains=("$domain")
	else
		domain=${domain#'www.'}
		domains=("$domain" "www.$domain")
	fi

	site_conf_dir="/etc/nginx/sites-available/$SITE"
	site_conf_file="$site_conf_dir/$SITE"
	domain_conf_file="$site_conf_dir/after/$domain"

	[[ -f $site_conf_file ]] || abort "Site config not found ($site_conf_file)"

	if [[ -f $domain_conf_file && -z ${args[--force]} ]]; then
		abort "$domain is already parked on $SITE"
	fi

	if [[ -z $use_dns ]]; then
		root_write "$domain_conf_file" <<EOF
server {
	listen 80;
	listen [::]:80;
	server_name ${domains[*]};
	root /sites/.certbot/;
}
EOF
		reload_nginx
		certbot_args=(--webroot --webroot-path /sites/.certbot/)
	else
		certbot_args=(--manual --preferred-challenges dns)
	fi

	for _domain in "${domains[@]}"; do
		certbot_args+=(-d "$_domain")
	done

	if ! sudo certbot certonly "${certbot_args[@]}"; then
		if [[ -z $use_dns ]]; then
			rm "$domain_conf_file"
		fi
		exit 1
	fi

	ssl_conf="/etc/letsencrypt/renewal/$domain.conf"
	ssl_cert="/etc/letsencrypt/live/$domain/fullchain.pem"
	ssl_key="/etc/letsencrypt/live/$domain/privkey.pem"

	if [[ -f "$ssl_conf" ]] && ! grep -q webroot_path "$ssl_conf"; then
		# Change SSL renewal from DNS challenge to HTTP
		{
			sed -E \
				-e 's/^pref_challs .+/pref_challs = http-01/' \
				-e 's/^authenticator .+/authenticator = webroot/' \
				"$ssl_conf"
			echo 'webroot_path = /sites/.certbot'
			echo '[[webroot_map]]'
			for _domain in "${domains[@]}"; do
				echo "$_domain = /sites/.certbot"
			done
		} | root_write "$ssl_conf"
	fi

	{
		cat <<EOF
server {
	listen 80;
	listen [::]:80;
	server_name ${domains[@]};

	return 301 https://$domain\$request_uri;
}
EOF
		echo
		sudo awk '/^(server[[:space:]]*\{|}|\s)/' "$site_conf_file" |\
		sed -E "s%server_name .+%server_name ${domains[*]};%" |\
		sed -E "s%ssl_certificate .+%ssl_certificate $ssl_cert;%" |\
		sed -E "s%ssl_certificate_key .+%ssl_certificate_key $ssl_key;%"
	} | root_write "$domain_conf_file"

	reload_nginx

	success "Parked $domain on $SITE"

}

spinup_parked_command() {

	#!/usr/bin/env bash

	for site in /etc/nginx/sites-available/*/; do
		readarray -t parked < <(find "${site}after/" -type f -not -name '*.conf' 2>/dev/null)
		if (( ${#parked[@]} )); then
			parked=("${parked[@]##*/}")
			basename "$site"
			print_tree_list "${parked[@]}"
		fi
	done

}

spinup_unpark_command() {

	#!/usr/bin/env bash

	require_site
	confirm_site

	domain="${args[domain]}"
	domain_root=$domain

	if [[ -z "${args[--exact]}" ]]; then
		domain_root="${domain#'www.'}"
	fi

	domain_conf="/etc/nginx/sites-available/$SITE/after/$domain_root"

	[[ -f "$domain_conf" ]] || abort "$domain is not parked on $SITE"

	sudo rm -rf \
		"$domain_conf" \
		"/etc/letsencrypt/renewal/$domain_root.conf" \
		"/etc/letsencrypt/archive/$domain_root/" \
		"/etc/letsencrypt/live/$domain_root/"

	reload_nginx

	success "Unparked $domain"

}

spinup_wp_command() {

	#!/usr/bin/env bash

	# shellcheck disable=SC2154
	wp_args=("${command_line_args[@]:1}")

	split_at=-1
	for split_at in "${!wp_args[@]}"; do
		if [[ ${wp_args[$split_at]} == -- ]]; then
			break
		fi
		split_at=-1
	done

	if (( split_at > -1 )); then
		sites=("${wp_args[@]:0:split_at}")
		# shellcheck disable=SC2034
		wp_args=("${wp_args[@]:split_at+1}")

		require_sites "${sites[@]}"
	else
		init_sites
	fi

	for site in "${SPINUP_SITES[@]}"; do
		set_site "$site"

		if ! find_site_wp; then
			echo "○ $site"
			echo '└ No WordPress found.'
			continue
		fi

		wp_result=$(run_site_wp "${wp_args[@]}" 2>&1)
		wp_status=$?

		echo "$(status_marker "$wp_status") $site"
		if [[ -n $wp_result ]]; then
			echo "$wp_result"
		fi
	done

}

spinup_traffic_command() {

	#!/usr/bin/env bash

	if ! command -v goaccess > /dev/null; then
		echo 'Installing traffic monitor (GoAccess)...'
		sudo apt install goaccess -y || exit $?
	fi

	goaccess /sites/*/logs/access.log --log-format=COMBINED

}

spinup_jail_status_command() {

	#!/usr/bin/env bash

	# shellcheck disable=SC2154
	jail=${args[jail]}

	if [[ -n $jail ]]; then
		jail_status=$(sudo fail2ban-client status "$jail")

		echo "$jail_status" | grep -oP '(Current|Total).+' | column -t -s '	'

		ip_list=$(echo "$jail_status" | grep 'Banned IP list:' | sed 's/.*Banned IP list:[[:space:]]*//')

		if [[ -n $ip_list ]]; then
			# shellcheck disable=SC2086
			print_numbered_list $ip_list
		fi
	else
		for jail in $(sudo fail2ban-client status | grep 'Jail list:' | sed -E 's/^[^:]+:[ \t]+//' | tr ',' ' '); do
			echo "$(status_marker 0) $jail"
			readarray -t info < <(sudo fail2ban-client status "$jail" | grep -oP '(Current|Total).+' | column -t -s '	')
			print_tree_list "${info[@]}"
		done
	fi

}

spinup_jail_remove_command() {

	#!/usr/bin/env bash

	ips=''
	# shellcheck disable=SC2154
	eval "ips=(${args[ip]})"
	sudo fail2ban-client unban "${ips[@]}"

}

spinup_jail_ignore_command() {

	#!/usr/bin/env bash

	read_ini /etc/fail2ban/jail.local

	ignore_ips=${ini[DEFAULT.ignoreip]}

	if [[ -n ${args[ip]} ]]; then
		ips=''
		eval "ips=(${args[ip]})"
		ignore_ips=" ${ignore_ips} "
		for ip in "${ips[@]}"; do
			if [[ " $ignore_ips " == *" $ip "* ]]; then
				if [[ -n ${args[--clear]} ]]; then
					ignore_ips=${ignore_ips/" $ip "/' '}
					success "$ip unignored"
				else
					warning "$ip already ignored"
				fi
			elif [[ -n ${args[--clear]} ]]; then
				warning "$ip is not ignored"
			else
				ignore_ips+="$ip "
				success "$ip ignored"
			fi
		done

		ini[DEFAULT.ignoreip]=$(echo "$ignore_ips" | sed 's/^ *//;s/ *$//')
		save_ini
		sudo fail2ban-client reload > /dev/null

	elif [[ -n ${args[--clear]} && -n $ignore_ips ]]; then
		if ! confirm 'Clear ignored IPs?'; then
			abort
		fi

		ini[DEFAULT.ignoreip]=''
		save_ini
		sudo fail2ban-client reload > /dev/null

		success 'Ignore list cleared'

	elif [[ -z $ignore_ips ]]; then
		echo 'No ignored IPs'

	else
		# shellcheck disable=SC2086
		print_numbered_list $ignore_ips
	fi

}

spinup_redis_list_command() {

	#!/usr/bin/env bash

	init_sites

	systemctl list-units 'redis-*' --type=service --all --plain --no-legend --no-pager |
	grep -v '^redis-server.service' |
	while read -r name loaded service status _; do
		name=${name%.service}
		user=${name#redis-}
		site=${SPINUP_SITES_BY_USER[$user]}

		set_user "$user"

		if [[ $loaded != loaded ]]; then
			add_error "Redis is $loaded"
		elif [[ $status != running ]]; then
			add_error "Redis is $status"
		elif [[ $service != active ]]; then
			add_error "Redis is $service"
		fi

		if [[ -z $site ]]; then
			add_notice "No site found for user"
		fi

		if [[ -n ${args[--ping]} ]]; then
			ping=$(sudo -u "$user" redis-cli -s "$REDIS_SOCKET" PING 2>&1)
			if [[ $ping != PONG ]]; then
				add_error "$ping"
			fi
		fi

		label="$user"
		if [[ -n "$site" ]]; then
			label+=" ($site)"
		fi

		print_messages "$label"
	done

}

spinup_redis_on_command() {

	#!/usr/bin/env bash

	SPINUP_SITES_FILTER() {
		! user_has_redis "${SPINUP_USERS[$1]:-$1}"
	}

	require_sites
	confirm_sites

	memory=${args[--memory]:-256MB}
	service_names=()

	for site in "${SPINUP_SITES[@]}"; do
		set_site "$site"

		redis_run_dir=${REDIS_SOCKET%/*}
		redis_config_dir=${REDIS_CONFIG_FILE%/*}

		[[ -d $redis_config_dir ]] || sudo mkdir -p "$redis_config_dir"

		root_write "$REDIS_CONFIG_FILE" <<-EOF
	protected-mode yes

	port 0
	unixsocket $REDIS_SOCKET
	unixsocketperm 600

	pidfile ${REDIS_SOCKET/.sock/.pid}
	logfile $SITE_HOME/logs/redis.log
	loglevel notice

	maxmemory $memory
	maxmemory-policy allkeys-lfu

	dir $SITE_HOME/redis
	dbfilename dump.rdb
	databases 1

	save ""
	timeout 0
	daemonize no
	appendonly no
	always-show-logo no
	set-proc-title yes
	proc-title-template "{title} {listen-addr} {server-mode}"
	locale-collate ""
	stop-writes-on-bgsave-error yes
	rdbcompression yes
	rdbchecksum yes
	rdb-del-sync-files no
	replica-serve-stale-data yes
	replica-read-only yes
	repl-diskless-sync yes
	repl-diskless-sync-delay 5
	repl-diskless-sync-max-replicas 0
	repl-diskless-load disabled
	repl-disable-tcp-nodelay no
	replica-priority 100
	acllog-max-len 128
	lazyfree-lazy-eviction no
	lazyfree-lazy-expire no
	lazyfree-lazy-server-del no
	replica-lazy-flush no
	lazyfree-lazy-user-del no
	lazyfree-lazy-user-flush no
	oom-score-adj no
	oom-score-adj-values 0 200 800
	disable-thp yes

	slowlog-log-slower-than 10000
	slowlog-max-len 128
	latency-monitor-threshold 0
	notify-keyspace-events ""
	hash-max-listpack-entries 512
	hash-max-listpack-value 64
	list-max-listpack-size -2
	list-compress-depth 0
	set-max-intset-entries 512
	set-max-listpack-entries 128
	set-max-listpack-value 64
	zset-max-listpack-entries 128
	zset-max-listpack-value 64
	hll-sparse-max-bytes 3000
	stream-node-max-bytes 4096
	stream-node-max-entries 100
	activerehashing yes
	client-output-buffer-limit normal 0 0 0
	client-output-buffer-limit replica 256mb 64mb 60
	client-output-buffer-limit pubsub 32mb 8mb 60
	hz 10
	dynamic-hz yes
	aof-rewrite-incremental-fsync yes
	rdb-save-incremental-fsync yes
	jemalloc-bg-thread yes
	EOF

	root_write "$REDIS_SERVICE_FILE" <<-EOF
	[Unit]
	Description=Redis for $SITE_USER
	After=network.target
	Documentation=http://redis.io/documentation, man:redis-server(1)

	[Service]
	Type=notify
	ExecStart=/usr/bin/redis-server $REDIS_CONFIG_FILE --supervised systemd
	TimeoutStartSec=30
	TimeoutStopSec=30
	User=$SITE_USER
	Group=$SITE_USER
	RuntimeDirectory=${redis_run_dir##*/}

	UMask=007
	LimitNOFILE=65535
	PrivateTmp=yes
	PrivateDevices=yes
	ProtectHome=yes
	ProtectSystem=full
	ReadOnlyDirectories=/
	ReadWriteDirectories=-$redis_run_dir
	ReadWriteDirectories=-$SITE_HOME/redis
	ReadWriteDirectories=-$SITE_HOME/logs

	NoNewPrivileges=true
	CapabilityBoundingSet=CAP_SYS_RESOURCE
	RestrictAddressFamilies=AF_UNIX
	MemoryDenyWriteExecute=true
	ProtectKernelModules=true
	ProtectKernelTunables=true
	ProtectControlGroups=true
	RestrictRealtime=true
	RestrictNamespaces=true

	[Install]
	WantedBy=multi-user.target
	EOF

	service_names+=("${REDIS_SERVICE_FILE##*/}")
done

sudo systemctl daemon-reload
sudo systemctl --quiet enable "${service_names[@]}"
sudo systemctl restart "${service_names[@]}"

for site in "${SPINUP_SITES[@]}"; do
	set_site "$site"

	if ! find_site_wp; then
		notice "$site"
		echo '└ No WordPress found'

	elif wp_result=$(run_site_wp eval-file - 2>&1 <<-PHP
		<?php
		\$options = [
			'anchor' => '<?php',
			'placement' => 'after',
		];
		\$config = new WPConfigTransformer( WP_CLI\Utils\locate_wp_config() );
		\$config->remove( 'constant', 'WP_REDIS_DISABLED' );
		\$config->update( 'constant', 'WP_REDIS_SCHEME', 'unix', \$options );
		\$config->update( 'constant', 'WP_REDIS_PATH', '$REDIS_SOCKET', \$options );
		\$config->update( 'constant', 'WP_REDIS_PREFIX', '', \$options );
		PHP
		)
		then
		success "$site"
	else
		error "$site"
		echo "└ Failed to configure WordPress: $wp_result"
	fi
done

}

spinup_redis_off_command() {

	#!/usr/bin/env bash

	SPINUP_ACCEPT_SITE() {
		user_has_redis "${SPINUP_USERS[$1]:-$1}"
	}

	require_sites
	confirm_sites

	cleanup=()
	service_names=()

	for site in "${SPINUP_SITES[@]}"; do
		set_site "$site" "${SPINUP_USERS[$site]:-$site}"

		if [[ -z ${SPINUP_USERS[$site]} ]]; then
			:
		elif ! find_site_wp; then
			notice "$site"
			echo '└ No WordPress found'
		elif ! wp_result=$(run_site_wp --skip-wordpress eval-file - 2>&1 <<-PHP
		<?php
		\$config = new WPConfigTransformer( WP_CLI\Utils\locate_wp_config() );
		\$config->remove( 'constant', 'WP_REDIS_SCHEME' );
		\$config->remove( 'constant', 'WP_REDIS_PATH' );
		\$config->remove( 'constant', 'WP_REDIS_PREFIX' );
		PHP
		)
		then
		error "$site"
		echo "└ Failed to configure WordPress: $wp_result"
		continue
	fi

	cleanup+=("$REDIS_SERVICE_FILE")
	cleanup+=("$REDIS_CONFIG_FILE")
	cleanup+=("$SITE_HOME/redis")

	service_names+=("${REDIS_SERVICE_FILE##*/}")
done

if (( ${#cleanup[@]} == 0 )); then
	abort
fi

sudo systemctl --now --quiet disable "${service_names[@]}"
sudo rm -rf "${cleanup[@]}"
sudo systemctl daemon-reload

success 'Redis disabled'

}

spinup_setup_command() {

	#!/usr/bin/env bash

	if ! confirm 'Continue to setup server?'; then
		abort
	fi

	[[ -d /etc/nginx/http/ ]] || sudo mkdir -p /etc/nginx/http

	nginx_conf=/etc/nginx/nginx.conf
	if ! grep -q 'include http/\*.conf;' "$nginx_conf"; then
		sudo sed -i '/^http {/a \\t# Include http modules\n\tinclude http/*.conf;\n' "$nginx_conf"
		test_nginx
	fi

	#
	# Install daily cron script for generating Cloudflare real IP config for NGINX.
	#

	cloudflare_real_ip=/etc/cron.daily/nginx-cloudflare-real-ip

	root_write "$cloudflare_real_ip" <<'EOF'
#!/bin/bash

if ! ip4=$(curl -fsL https://www.cloudflare.com/ips-v4); then
	echo 'Failed to fetch Cloudflare IPv4 addresses' >&2
	exit 1
fi

if ! ip6=$(curl -fsL https://www.cloudflare.com/ips-v6); then
	echo 'Failed to fetch Cloudflare IPv6 addresses' >&2
	exit 1
fi

{
	for i in $ip4; do
		echo "set_real_ip_from $i;"
	done

	echo ''

	for i in $ip6; do
		echo "set_real_ip_from $i;"
	done

	echo ''
	echo 'real_ip_header CF-Connecting-IP;'
	echo ''
} > /etc/nginx/http/cloudflare-real-ip.conf

if ! nginx -t -q; then
	exit 1
fi

nginx -s reload &> /dev/null
EOF

	sudo chmod +x "$cloudflare_real_ip"

	sudo bash "$cloudflare_real_ip" || exit $?

	success 'Configured Cloudflare real IP'

	#
	# Install NGINX Firewall
	#
	# https://perishablepress.com/8g-firewall/
	#

	if ! firewall=$(curl -fsSL https://raw.githubusercontent.com/t18d/nG-SetEnvIf/refs/heads/develop/8g-firewall.conf); then
		abort 'Failed to download NGINX firewall'
	fi

	if ! firewall_site=$(curl -fsSL https://raw.githubusercontent.com/t18d/nG-SetEnvIf/refs/heads/develop/8g.conf); then
		abort 'Failed to download NGINX firewall'
	fi

	firewall_file=/etc/nginx/http/firewall.conf
	firewall_site_file=/etc/nginx/global/firewall.conf

	echo "$firewall" | root_write "$firewall_file"
	echo "$firewall_site" | root_write "$firewall_site_file"

	test_nginx

	for site_conf_dir in /etc/nginx/sites-available/*/server/; do
		site_conf_file="$site_conf_dir${firewall_site_file##*/}"
		if [[ ! -L "$site_conf_file" || $(readlink "$site_conf_file") != "$firewall_site_file" ]]; then
			if [[ -e "$site_conf_file" ]] && ! sudo rm "$site_conf_file"; then
				warning "Failed to remove $site_conf_file"
			else
				sudo ln -s "$firewall_site_file" "$site_conf_file"
			fi
		fi
	done

	test_nginx

	success 'Configured NGINX firewall'

	#
	# Configure fail2ban
	#

	root_write /etc/fail2ban/fail2ban.local <<'EOF'
[DEFAULT]

allowipv6 = auto

EOF

	root_write /etc/fail2ban/paths-overrides.local <<'EOF'
[DEFAULT]

nginx_access_log = /sites/*/logs/access.log
nginx_error_log = /sites/*/logs/error.log

EOF

	root_write /etc/fail2ban/jail.local <<'EOF'
[DEFAULT]

bantime = 1d
backend = auto

[sshd]

enabled = true
maxretry = 1

[wp-login]

enabled = true
filter = wp-login
port = http,https
logpath = %(nginx_access_log)s
maxretry = 5
findtime = 10m

[firewall]

enabled = true
filter = firewall
port = http,https
logpath = %(nginx_access_log)s
maxretry = 5
findtime = 10m

EOF

	root_write /etc/fail2ban/filter.d/wp-login.conf <<'EOF'
[Definition]

failregex = ^<HOST> .* "POST /+wp-login\.php[^"]*" 200

EOF

	root_write /etc/fail2ban/filter.d/firewall.conf <<'EOF'
[Definition]

failregex = ^<HOST> .* "[^"]+" 403

EOF

	if ! sudo fail2ban-client reload > /dev/null; then
		abort
	fi

	success 'Configured jail'

}

parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--version | -v)
				version_command
				exit
				;;

			--help | -h)
				long_usage=yes
				spinup_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action=${1:-}

	case $action in
		-*) ;;

		status)
			action="status"
			shift
			spinup_status_parse_requirements "$@"
			shift $#
			;;

		sites)
			action="sites"
			shift
			spinup_sites_parse_requirements "$@"
			shift $#
			;;

		users)
			action="users"
			shift
			spinup_users_parse_requirements "$@"
			shift $#
			;;

		park)
			action="park"
			shift
			spinup_park_parse_requirements "$@"
			shift $#
			;;

		parked)
			action="parked"
			shift
			spinup_parked_parse_requirements "$@"
			shift $#
			;;

		unpark)
			action="unpark"
			shift
			spinup_unpark_parse_requirements "$@"
			shift $#
			;;

		wp)
			action="wp"
			shift
			spinup_wp_parse_requirements "$@"
			shift $#
			;;

		traffic)
			action="traffic"
			shift
			spinup_traffic_parse_requirements "$@"
			shift $#
			;;

		jail)
			action="jail"
			shift
			spinup_jail_parse_requirements "$@"
			shift $#
			;;

		redis)
			action="redis"
			shift
			spinup_redis_parse_requirements "$@"
			shift $#
			;;

		setup)
			action="setup"
			shift
			spinup_setup_parse_requirements "$@"
			shift $#
			;;

		"")
			spinup_usage >&2
			exit 1
			;;

		*)
			printf "invalid command: %s\n" "$action" >&2
			exit 1
			;;

	esac

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_status_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_status_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="status"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				escaped="$(printf '%q' "$1")"
				if [[ -z ${args['site']+x} ]]; then
					args['site']="$escaped"
					unique_lookup["site:$escaped"]=1
				elif [[ -z "${unique_lookup["site:$escaped"]:-}" ]]; then
					args['site']="${args['site']} $escaped"
					unique_lookup["site:$escaped"]=1

				fi
				shift

				;;

		esac
	done

}

spinup_sites_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_sites_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="sites"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_users_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_users_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="users"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_park_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_park_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="park"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--use-dns)

				args['--use-dns']=1
				shift
				;;

			--exact)

				args['--exact']=1
				shift
				;;

			--force)

				args['--force']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				if [[ -z ${args['domain']+x} ]]; then
					args['domain']=$1
					shift

				elif [[ -z ${args['site']+x} ]]; then
					args['site']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

	if [[ -z ${args['domain']+x} ]]; then
		printf "missing required argument: DOMAIN\nusage: spinup park DOMAIN [SITE] [OPTIONS]\n" >&2

		exit 1
	fi

}

spinup_parked_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_parked_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="parked"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_unpark_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_unpark_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="unpark"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--exact)

				args['--exact']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				if [[ -z ${args['domain']+x} ]]; then
					args['domain']=$1
					shift

				elif [[ -z ${args['site']+x} ]]; then
					args['site']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

	if [[ -z ${args['domain']+x} ]]; then
		printf "missing required argument: DOMAIN\nusage: spinup unpark DOMAIN [SITE] [OPTIONS]\n" >&2

		exit 1
	fi

}

spinup_wp_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_wp_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="wp"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--)
				shift
				other_args+=("$@")
				break
				;;

			-?*)
				other_args+=("$1")
				shift
				;;

			*)

				other_args+=("$1")
				shift

				;;

		esac
	done

}

spinup_traffic_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_traffic_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="traffic"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_jail_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_jail_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action=${1:-}

	case $action in
		-*) ;;

		status)
			action="status"
			shift
			spinup_jail_status_parse_requirements "$@"
			shift $#
			;;

		remove)
			action="remove"
			shift
			spinup_jail_remove_parse_requirements "$@"
			shift $#
			;;

		ignore)
			action="ignore"
			shift
			spinup_jail_ignore_parse_requirements "$@"
			shift $#
			;;

		"")
			spinup_jail_usage >&2
			exit 1
			;;

		*)
			printf "invalid command: %s\n" "$action" >&2
			exit 1
			;;

	esac

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_jail_status_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_jail_status_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="jail status"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				if [[ -z ${args['jail']+x} ]]; then
					args['jail']=$1
					shift
				else
					printf "invalid argument: %s\n" "$key" >&2
					exit 1
				fi

				;;

		esac
	done

}

spinup_jail_remove_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_jail_remove_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="jail remove"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				escaped="$(printf '%q' "$1")"
				if [[ -z ${args['ip']+x} ]]; then
					args['ip']="$escaped"
					unique_lookup["ip:$escaped"]=1
				elif [[ -z "${unique_lookup["ip:$escaped"]:-}" ]]; then
					args['ip']="${args['ip']} $escaped"
					unique_lookup["ip:$escaped"]=1

				fi
				shift

				;;

		esac
	done

	if [[ -z ${args['ip']+x} ]]; then
		printf "missing required argument: IP\nusage: spinup jail remove IP...\n" >&2

		exit 1
	fi

}

spinup_jail_ignore_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_jail_ignore_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="jail ignore"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--clear)

				args['--clear']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				escaped="$(printf '%q' "$1")"
				if [[ -z ${args['ip']+x} ]]; then
					args['ip']="$escaped"
					unique_lookup["ip:$escaped"]=1
				elif [[ -z "${unique_lookup["ip:$escaped"]:-}" ]]; then
					args['ip']="${args['ip']} $escaped"
					unique_lookup["ip:$escaped"]=1

				fi
				shift

				;;

		esac
	done

}

spinup_redis_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_redis_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action=${1:-}

	case $action in
		-*) ;;

		list)
			action="list"
			shift
			spinup_redis_list_parse_requirements "$@"
			shift $#
			;;

		on)
			action="on"
			shift
			spinup_redis_on_parse_requirements "$@"
			shift $#
			;;

		off)
			action="off"
			shift
			spinup_redis_off_parse_requirements "$@"
			shift $#
			;;

		"")
			spinup_redis_usage >&2
			exit 1
			;;

		*)
			printf "invalid command: %s\n" "$action" >&2
			exit 1
			;;

	esac

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_redis_list_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_redis_list_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="redis list"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--ping)

				args['--ping']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

spinup_redis_on_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_redis_on_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="redis on"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--memory)

				if [[ -n ${2+x} ]]; then
					args['--memory']="$2"
					shift
					shift
				else
					printf "%s\n" "--memory requires an argument: --memory MEMORY_LIMIT" >&2
					exit 1
				fi
				;;

			--all)

				args['--all']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				escaped="$(printf '%q' "$1")"
				if [[ -z ${args['site']+x} ]]; then
					args['site']="$escaped"
					unique_lookup["site:$escaped"]=1
				elif [[ -z "${unique_lookup["site:$escaped"]:-}" ]]; then
					args['site']="${args['site']} $escaped"
					unique_lookup["site:$escaped"]=1

				fi
				shift

				;;

		esac
	done

	[[ -n ${args['--memory']:-} ]] || args['--memory']="256MB"

}

spinup_redis_off_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_redis_off_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="redis off"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			--all)

				args['--all']=1
				shift
				;;

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				escaped="$(printf '%q' "$1")"
				if [[ -z ${args['site']+x} ]]; then
					args['site']="$escaped"
					unique_lookup["site:$escaped"]=1
				elif [[ -z "${unique_lookup["site:$escaped"]:-}" ]]; then
					args['site']="${args['site']} $escaped"
					unique_lookup["site:$escaped"]=1

				fi
				shift

				;;

		esac
	done

}

spinup_setup_parse_requirements() {
	local key

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in
			--help | -h)
				long_usage=yes
				spinup_setup_usage
				exit
				;;

			*)
				break
				;;

		esac
	done

	action="setup"

	while [[ $# -gt 0 ]]; do
		key="$1"
		case "$key" in

			-?*)
				printf "invalid option: %s\n" "$key" >&2
				exit 1
				;;

			*)

				printf "invalid argument: %s\n" "$key" >&2
				exit 1

				;;

		esac
	done

}

initialize() {
	declare -g version="0.1.0"

}

run() {

	declare -g long_usage=''
	declare -g -A args=()
	declare -g -a other_args=()
	declare -g -A deps=()
	declare -g -a env_var_names=()
	declare -g -a input=()
	declare -g -A unique_lookup=()

	normalize_input "$@"
	parse_requirements "${input[@]}"

	case "$action" in
		"status") spinup_status_command ;;
		"sites") spinup_sites_command ;;
		"users") spinup_users_command ;;
		"park") spinup_park_command ;;
		"parked") spinup_parked_command ;;
		"unpark") spinup_unpark_command ;;
		"wp") spinup_wp_command ;;
		"traffic") spinup_traffic_command ;;
		"jail") spinup_jail_command ;;
		"jail status") spinup_jail_status_command ;;
		"jail remove") spinup_jail_remove_command ;;
		"jail ignore") spinup_jail_ignore_command ;;
		"redis") spinup_redis_command ;;
		"redis list") spinup_redis_list_command ;;
		"redis on") spinup_redis_on_command ;;
		"redis off") spinup_redis_off_command ;;
		"setup") spinup_setup_command ;;
	esac
}

command_line_args=("$@")
initialize
run "${command_line_args[@]}"
